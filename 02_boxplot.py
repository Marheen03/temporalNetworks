import utils, plot, os
import networkx as nx
import numpy as np

numOfFlies = 12
usingWeights = False
accumulated = True
isDirected = True

"""
#=========CsCh=========
nw_10sec = [0.20833333333333334, 0.26666666666666666, 0.23333333333333334, 0.3, 0.325, 0.25, 0.25, 0.25, 0.21666666666666667, 0.3, 0.2916666666666667, 0.25, 0.23333333333333334, 0.275, 0.25833333333333336, 0.25833333333333336, 0.26666666666666666, 0.3333333333333333, 0.18333333333333332, 0.25, 0.3, 0.35, 0.25, 0.225, 0.325, 0.20833333333333334, 0.2833333333333333, 0.30833333333333335, 0.2, 0.225, 0.20833333333333334, 0.21666666666666667, 0.25833333333333336, 0.30833333333333335, 0.24166666666666667, 0.3333333333333333, 0.35, 0.25833333333333336, 0.24166666666666667, 0.25833333333333336, 0.21666666666666667, 0.2, 0.225, 0.23333333333333334, 0.24166666666666667, 0.24166666666666667, 0.35, 0.26666666666666666, 0.25833333333333336, 0.24166666666666667, 0.275, 0.31666666666666665, 0.2916666666666667, 0.2916666666666667, 0.30833333333333335, 0.30833333333333335, 0.2916666666666667, 0.24166666666666667, 0.21666666666666667, 0.21666666666666667, 0.2833333333333333, 0.24166666666666667, 0.2916666666666667, 0.25, 0.225, 0.2916666666666667]
nw_30sec = [0.375, 0.425, 0.35, 0.55, 0.425, 0.35, 0.525, 0.25, 0.525, 0.375, 0.375, 0.35, 0.4, 0.35, 0.45, 0.25, 0.375, 0.55, 0.475, 0.425, 0.4, 0.375, 0.4, 0.375, 0.4, 0.275, 0.45, 0.375, 0.35, 0.4, 0.4, 0.3, 0.325, 0.425, 0.35, 0.55, 0.6, 0.425, 0.3, 0.35, 0.425, 0.175, 0.325, 0.375, 0.425, 0.425, 0.375, 0.3, 0.325, 0.475, 0.55, 0.425, 0.375, 0.275, 0.4, 0.35, 0.375, 0.475, 0.275, 0.225, 0.45, 0.3, 0.325, 0.475, 0.3, 0.5]
w_10sec = [0.20833333333333334, 0.2833333333333333, 0.25, 0.2833333333333333, 0.325, 0.26666666666666666, 0.23333333333333334, 0.225, 0.2, 0.2916666666666667, 0.23333333333333334, 0.2833333333333333, 0.21666666666666667, 0.24166666666666667, 0.225, 0.25833333333333336, 0.275, 0.31666666666666665, 0.175, 0.25, 0.26666666666666666, 0.325, 0.2, 0.23333333333333334, 0.3, 0.23333333333333334, 0.2833333333333333, 0.3, 0.21666666666666667, 0.20833333333333334, 0.20833333333333334, 0.225, 0.275, 0.3, 0.25, 0.35, 0.35833333333333334, 0.25833333333333336, 0.24166666666666667, 0.24166666666666667, 0.225, 0.20833333333333334, 0.23333333333333334, 0.24166666666666667, 0.25833333333333336, 0.26666666666666666, 0.3416666666666667, 0.25, 0.2833333333333333, 0.23333333333333334, 0.2916666666666667, 0.31666666666666665, 0.2916666666666667, 0.3416666666666667, 0.2916666666666667, 0.3, 0.3, 0.25, 0.23333333333333334, 0.225, 0.26666666666666666, 0.19166666666666668, 0.3, 0.2833333333333333, 0.25, 0.2916666666666667]
w_30sec = [0.25, 0.35, 0.325, 0.45, 0.3, 0.25, 0.325, 0.225, 0.3, 0.25, 0.3, 0.4, 0.3, 0.325, 0.25, 0.3, 0.35, 0.475, 0.5, 0.3, 0.25, 0.35, 0.225, 0.3, 0.45, 0.35, 0.4, 0.35, 0.35, 0.225, 0.325, 0.225, 0.275, 0.3, 0.325, 0.3, 0.475, 0.375, 0.15, 0.375, 0.275, 0.225, 0.35, 0.35, 0.325, 0.375, 0.4, 0.35, 0.375, 0.375, 0.425, 0.425, 0.325, 0.3, 0.325, 0.325, 0.35, 0.3, 0.225, 0.275, 0.4, 0.2, 0.325, 0.275, 0.25, 0.4]
"""

"""
#=========Cs_5DIZ=========
nw_10sec = [0.20833333333333334, 0.16666666666666666, 0.225, 0.26666666666666666, 0.13333333333333333, 0.2, 0.175, 0.24166666666666667, 0.15833333333333333, 0.19166666666666668, 0.2, 0.16666666666666666, 0.15, 0.175, 0.2, 0.15, 0.175, 0.23333333333333334, 0.18333333333333332, 0.23333333333333334, 0.175, 0.175, 0.20833333333333334, 0.18333333333333332, 0.20833333333333334, 0.2833333333333333, 0.15833333333333333, 0.23333333333333334, 0.225, 0.14166666666666666, 0.175, 0.16666666666666666, 0.16666666666666666, 0.15, 0.23333333333333334, 0.175, 0.31666666666666665, 0.26666666666666666, 0.18333333333333332, 0.25, 0.18333333333333332, 0.21666666666666667, 0.23333333333333334, 0.18333333333333332, 0.15, 0.23333333333333334, 0.19166666666666668, 0.23333333333333334, 0.20833333333333334, 0.225, 0.2, 0.25, 0.2916666666666667, 0.25, 0.16666666666666666, 0.16666666666666666, 0.18333333333333332, 0.19166666666666668, 0.225, 0.15, 0.225, 0.225, 0.275, 0.24166666666666667, 0.20833333333333334, 0.23333333333333334]
nw_30sec = [0.35, 0.3, 0.45, 0.45, 0.25, 0.175, 0.325, 0.325, 0.3, 0.325, 0.45, 0.3, 0.25, 0.35, 0.325, 0.225, 0.25, 0.3, 0.35, 0.35, 0.275, 0.325, 0.3, 0.25, 0.325, 0.375, 0.325, 0.325, 0.35, 0.275, 0.325, 0.225, 0.4, 0.275, 0.375, 0.325, 0.45, 0.475, 0.275, 0.275, 0.35, 0.275, 0.3, 0.325, 0.25, 0.4, 0.275, 0.475, 0.275, 0.3, 0.4, 0.425, 0.375, 0.4, 0.275, 0.3, 0.275, 0.325, 0.225, 0.225, 0.275, 0.375, 0.375, 0.4, 0.275, 0.45]
w_10sec = [0.20833333333333334, 0.18333333333333332, 0.25, 0.2833333333333333, 0.125, 0.225, 0.175, 0.20833333333333334, 0.15, 0.15, 0.23333333333333334, 0.175, 0.14166666666666666, 0.16666666666666666, 0.2, 0.18333333333333332, 0.18333333333333332, 0.225, 0.20833333333333334, 0.225, 0.19166666666666668, 0.19166666666666668, 0.19166666666666668, 0.15833333333333333, 0.2, 0.30833333333333335, 0.18333333333333332, 0.21666666666666667, 0.23333333333333334, 0.15, 0.18333333333333332, 0.15833333333333333, 0.20833333333333334, 0.20833333333333334, 0.24166666666666667, 0.175, 0.2833333333333333, 0.26666666666666666, 0.2, 0.25, 0.19166666666666668, 0.18333333333333332, 0.20833333333333334, 0.2, 0.14166666666666666, 0.20833333333333334, 0.16666666666666666, 0.225, 0.23333333333333334, 0.225, 0.20833333333333334, 0.23333333333333334, 0.25, 0.20833333333333334, 0.175, 0.15833333333333333, 0.16666666666666666, 0.2, 0.225, 0.15, 0.25, 0.2, 0.31666666666666665, 0.21666666666666667, 0.25, 0.25833333333333336]
w_30sec = [0.3, 0.25, 0.4, 0.475, 0.25, 0.3, 0.325, 0.3, 0.25, 0.275, 0.3, 0.25, 0.25, 0.3, 0.325, 0.125, 0.25, 0.375, 0.35, 0.425, 0.3, 0.25, 0.35, 0.2, 0.375, 0.45, 0.175, 0.375, 0.25, 0.15, 0.2, 0.275, 0.3, 0.325, 0.3, 0.275, 0.375, 0.5, 0.25, 0.375, 0.3, 0.3, 0.3, 0.25, 0.175, 0.3, 0.2, 0.375, 0.25, 0.35, 0.375, 0.325, 0.375, 0.325, 0.25, 0.25, 0.225, 0.35, 0.25, 0.2, 0.275, 0.4, 0.4, 0.275, 0.35, 0.475]
"""

"""
#=========CTRL10=========
nw_10sec = [0.15, 0.20833333333333334, 0.21666666666666667, 0.21666666666666667, 0.175, 0.21666666666666667, 0.25833333333333336, 0.14166666666666666, 0.23333333333333334, 0.24166666666666667, 0.15, 0.14166666666666666, 0.15, 0.15, 0.225, 0.13333333333333333, 0.15, 0.14166666666666666, 0.25833333333333336, 0.21666666666666667, 0.21666666666666667, 0.26666666666666666, 0.18333333333333332, 0.20833333333333334, 0.2833333333333333, 0.15833333333333333, 0.14166666666666666, 0.18333333333333332, 0.2, 0.18333333333333332, 0.16666666666666666, 0.15, 0.24166666666666667, 0.18333333333333332, 0.14166666666666666, 0.20833333333333334, 0.14166666666666666, 0.15833333333333333, 0.19166666666666668, 0.10833333333333334, 0.15, 0.11666666666666667, 0.13333333333333333, 0.175, 0.15, 0.16666666666666666, 0.25833333333333336, 0.125, 0.2, 0.18333333333333332, 0.175, 0.19166666666666668, 0.175, 0.24166666666666667, 0.16666666666666666, 0.15833333333333333, 0.21666666666666667, 0.19166666666666668, 0.25833333333333336, 0.13333333333333333, 0.19166666666666668, 0.23333333333333334, 0.10833333333333334, 0.275, 0.20833333333333334, 0.175]
nw_30sec = [0.2, 0.45, 0.375, 0.4, 0.275, 0.45, 0.325, 0.3, 0.325, 0.425, 0.3, 0.3, 0.275, 0.275, 0.475, 0.25, 0.325, 0.325, 0.35, 0.35, 0.4, 0.425, 0.375, 0.3, 0.375, 0.325, 0.3, 0.375, 0.275, 0.325, 0.375, 0.25, 0.4, 0.275, 0.325, 0.325, 0.2, 0.425, 0.35, 0.15, 0.375, 0.3, 0.225, 0.35, 0.25, 0.2, 0.425, 0.225, 0.275, 0.4, 0.3, 0.275, 0.375, 0.275, 0.275, 0.275, 0.35, 0.325, 0.275, 0.2, 0.325, 0.375, 0.2, 0.45, 0.4, 0.4]
w_10sec = [0.15833333333333333, 0.21666666666666667, 0.20833333333333334, 0.20833333333333334, 0.19166666666666668, 0.24166666666666667, 0.23333333333333334, 0.14166666666666666, 0.23333333333333334, 0.25833333333333336, 0.15833333333333333, 0.15, 0.15833333333333333, 0.16666666666666666, 0.2, 0.13333333333333333, 0.15833333333333333, 0.15, 0.26666666666666666, 0.2, 0.20833333333333334, 0.225, 0.18333333333333332, 0.20833333333333334, 0.275, 0.14166666666666666, 0.125, 0.16666666666666666, 0.19166666666666668, 0.2, 0.19166666666666668, 0.15, 0.25, 0.18333333333333332, 0.14166666666666666, 0.2, 0.13333333333333333, 0.15, 0.2, 0.11666666666666667, 0.15833333333333333, 0.125, 0.13333333333333333, 0.18333333333333332, 0.14166666666666666, 0.16666666666666666, 0.23333333333333334, 0.125, 0.19166666666666668, 0.175, 0.175, 0.21666666666666667, 0.16666666666666666, 0.225, 0.15, 0.19166666666666668, 0.21666666666666667, 0.2, 0.25833333333333336, 0.14166666666666666, 0.19166666666666668, 0.25, 0.125, 0.275, 0.2, 0.19166666666666668]
w_30sec = [0.3, 0.425, 0.325, 0.25, 0.35, 0.3, 0.425, 0.225, 0.325, 0.4, 0.225, 0.25, 0.375, 0.225, 0.45, 0.3, 0.25, 0.3, 0.3, 0.275, 0.45, 0.35, 0.35, 0.325, 0.4, 0.3, 0.275, 0.4, 0.35, 0.25, 0.325, 0.275, 0.375, 0.325, 0.25, 0.35, 0.175, 0.35, 0.375, 0.15, 0.275, 0.35, 0.3, 0.4, 0.225, 0.275, 0.3, 0.325, 0.225, 0.275, 0.3, 0.25, 0.3, 0.25, 0.25, 0.275, 0.35, 0.325, 0.4, 0.275, 0.275, 0.425, 0.3, 0.425, 0.275, 0.325]
"""

if isDirected:
    directed = "(USMJEREN)"
else:
    directed = "(NEUSMJEREN)"

snapshots_folder = 'treatments/30_sec_window/'
folders = os.listdir(snapshots_folder)
cumulativeDict = {}

# for each group
for folder in folders:
    if accumulated:
        coefficients = []
    else:
        dict = {}
        
    folder_path = snapshots_folder + folder
    treatments = os.listdir(folder_path)
    
    folderName = folder_path.split("/")
    if folderName[2] == "Cs_5DIZ":
        type = "IZOLIRANE"
    elif folderName[2] == "CS_10D":
        type = "STARE"
    else:
        type = "MLADE"
    
    if folderName[1][0] == "1":
        key = 'Louvain, 10sec, bez težina'
    else:
        key = 'Louvain, 30sec, bez težina'
    
    # for each treatment
    for i, treatment in enumerate(treatments):
        path = folder_path + "/" + treatment
        snapshot_graphs = utils.load_files_from_folder(path, n_sort=True, file_format=".gml")
        allFlies = utils.getAllFlies(numOfFlies)

        snapshotsCommunities = []
        # for each snapshot
        for j, graph_path in enumerate(snapshot_graphs.values()):
            if isDirected:
                G = nx.read_gml(graph_path)
            else:
                graph = nx.read_gml(graph_path)
                G = graph.to_undirected()

            if usingWeights:
                communities = nx.community.louvain_communities(G, weight="count", seed=100)
            else:
                communities = nx.community.louvain_communities(G, seed=100)
            print(i+1, j+1)

            # stores graph for each snapshot into an array
            snapshotsCommunities.append(communities)
        
        # makes snapshot IDs consistent
        consistent_snapshots = utils.track_consistent_communities(snapshotsCommunities)
        communitiesDict = []
        for communities in consistent_snapshots:
            communityOfNode = utils.get_community_of_node(communities, allFlies)
            communitiesDict.append(communityOfNode)

        matrix = utils.getHeatMapData(communitiesDict, allFlies, negative=False)    
        # get elements from matrix above diagonal
        upper_elements = matrix[np.triu_indices_from(matrix, k=1)]
        values = upper_elements.tolist()

        if accumulated:
            coefficients.extend(values)
        else:
            key1 = "{}.".format(i+1)
            dict.update({key1 : values})
    
    if accumulated:
        cumulativeDict.update({type : coefficients})
    else:
        plot.plotBoxPlot(dict, type, directed, accumulated, key)


if accumulated:
    plot.plotBoxPlot(cumulativeDict, key, directed, accumulated, key)


"""
data = {
    '10sec, težine': w_10sec,
    '10sec, bez težine': nw_10sec,
    '30sec, težine': w_30sec,
    '30sec, bez težine': nw_30sec
}
plot.plotBoxPlot(data, type, directed, accumulated)
"""